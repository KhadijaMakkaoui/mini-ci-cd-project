name: CI/CD WebApp + CloudFormation

on:
  push:
    branches: ["main"]

jobs:

  ######################################################
  # CI STEP — Test + CloudFormation Validation
  ######################################################
  validate:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Validate CloudFormation Templates
      run: |
        for file in cloudformation/*.yml; do
          echo "Validating $file..."
          aws cloudformation validate-template --template-body file://$file
        done
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}

  ######################################################
  # CD STEP — Deploy CloudFormation Infrastructure
  ######################################################
  deploy_infra:
    runs-on: ubuntu-latest
    needs: validate

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Deploy Network Stack
      run: |
        aws cloudformation deploy \
          --stack-name my-network \
          --template-file cloudformation/network.yml \
          --capabilities CAPABILITY_NAMED_IAM

    - name: Deploy Database Stack
      run: |
        aws cloudformation deploy \
          --stack-name my-database \
          --template-file cloudformation/database.yml \
          --capabilities CAPABILITY_NAMED_IAM \
          --parameter-overrides \
            VPCId=$(aws cloudformation describe-stacks --stack-name my-network --query "Stacks[0].Outputs[?OutputKey=='VPCId'].OutputValue" --output text) \
            PrivateSubnetId=$(aws cloudformation describe-stacks --stack-name my-network --query "Stacks[0].Outputs[?OutputKey=='PrivateSubnetId'].OutputValue" --output text)

    - name: Deploy WebApp Stack
      run: |
        aws cloudformation deploy \
          --stack-name my-webapp \
          --template-file cloudformation/webapp.yml \
          --capabilities CAPABILITY_NAMED_IAM \
          --parameter-overrides \
            VPCId=$(aws cloudformation describe-stacks --stack-name my-network --query "Stacks[0].Outputs[?OutputKey=='VPCId'].OutputValue" --output text) \
            PublicSubnetId=$(aws cloudformation describe-stacks --stack-name my-network --query "Stacks[0].Outputs[?OutputKey=='PublicSubnetId'].OutputValue" --output text)
            
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: ${{ secrets.AWS_REGION }}

  ######################################################
  # CD STEP — Deploy WebApp Files to EC2
  ######################################################
  deploy_app:
    runs-on: ubuntu-latest
    needs: deploy_infra

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install SSH Client
      run: sudo apt-get install -y openssh-client

    - name: Add Private Key
      run: |
        echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
        chmod 600 key.pem

    - name: Upload WebApp to EC2
      run: |
        scp -o StrictHostKeyChecking=no -i key.pem -r app/* ec2-user@${{ secrets.EC2_HOST }}:/var/www/html/

    - name: Restart Apache
      run: |
        ssh -o StrictHostKeyChecking=no -i key.pem ec2-user@${{ secrets.EC2_HOST }} "sudo systemctl restart httpd"
